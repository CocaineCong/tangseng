# Tangseng åŸºäºGoè¯­è¨€çš„æœç´¢å¼•æ“

# é¡¹ç›®å¤§ä½“æ¡†æ¶

1ã€ginä½œä¸ºhttpæ¡†æ¶ï¼Œgrpcä½œä¸ºrpcæ¡†æ¶ï¼Œetcdä½œä¸ºæœåŠ¡å‘ç°ã€‚\
2ã€æ€»ä½“æœåŠ¡åˆ†æˆ`ç”¨æˆ·æ¨¡å—`ã€`æ”¶è—å¤¹æ¨¡å—`ã€`æœç´¢å¼•æ“æ¨¡å—`ã€‚\
3ã€ç”¨æˆ·æ¨¡å—å’Œæ”¶è—å¤¹æ¨¡å—ä½¿ç”¨å…±åŒçš„æ•°æ®åº“ã€‚\
4ã€æœç´¢å¼•æ“å•ç‹¬è®¾ç«‹æ•°æ®åº“ï¼Œå¹¶ä¸”é¢„ç•™äº†ä¸€ä¸ªredisä½œä¸ºç¼“å­˜ï¼Œå­˜å‚¨æœç´¢å¼•æ“æ•°æ®é‡‡ç”¨è¯»å†™åˆ†ç¦»æ¨¡å¼ï¼Œä¸»è¦è´Ÿè´£è¯»ï¼Œæ¬¡è¦è´Ÿè´£å†™ï¼Œå…è®¸ä¸»ä»å¤åˆ¶çš„å»¶è¿Ÿã€‚

# ğŸ§‘ğŸ»â€ğŸ’» å‰ç«¯åœ°å€

å‰ç«¯ç”¨çš„æ˜¯ react, but still coding

[react-tangseng](https://github.com/CocaineCong/react-tangseng)

# ğŸŒˆ é¡¹ç›®ä¸»è¦åŠŸèƒ½
## 1. ç”¨æˆ·æ¨¡å—
- ç™»å½•æ³¨å†Œ

## 2. æ”¶è—å¤¹æ¨¡å—
- åˆ›å»º/æ›´æ–°/åˆ é™¤/å±•ç¤º æ”¶è—å¤¹
- å°†æœç´¢ç»“æœçš„urlè¿›è¡Œæ”¶è—å¤¹çš„åˆ›å»º/åˆ é™¤/å±•ç¤º

## 3. æœç´¢æ¨¡å—

> * x.termå­˜å‚¨termæ–‡ä»¶
> * x.forwardå­˜å‚¨æ­£æ’æ–‡ä»¶
> * x.invertedå­˜å‚¨å€’æ’ç´¢å¼•æ–‡ä»¶
> * segments.json å­˜å‚¨segmentå…ƒæ•°æ®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸Šè¿°æ–‡ä»¶å±æ€§

#### æ­£æ’åº“
* æ­£æ’æ–‡ä»¶ï¼Œé€šè¿‡ bolt è¿›è¡Œkvå­˜å‚¨ docid ä¸»é”®
#### å€’æ’åº“
* termæ–‡ä»¶ boltå­˜å‚¨ï¼Œkeyä¸ºtokenï¼Œvalue ä¸ºå¯¹åº”tokençš„postingslistï¼Œä½†ç”±äºæ–‡ä»¶å¤ªå¤§äº†ï¼Œåç»­æ”¹æˆå€’æ’ç´¢å¼•æ–‡ä»¶çš„offsetå’Œsizeï¼Œå‹ç¼©å­˜å‚¨å®¹é‡

**åç»­çœ‹å®ç°éš¾åº¦ï¼Œèƒ½ä¸èƒ½ç”¨mmapæ¥è¯»å–å€’æ’ç´¢å¼•** 

#### segment merge
* channel å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œflushåå‘é€æ¶ˆæ¯
* term mergeé€šè¿‡b+treeå‰åºéå†ï¼Œé‡ç»„b+tree
* å€’æ’è¡¨mergeçš„è¯ï¼Œå¯ä»¥é€šè¿‡merge b+æ ‘çš„æ—¶å€™ï¼Œè¯»å–å€’æ’è¡¨æ•°æ®ï¼Œè¿›è¡Œè¯»å–åé‡å†™ï¼Œæ•ˆç‡å¯èƒ½ä¼šæ…¢ï¼Œå¾…å®š
* éœ€è¦æ·»åŠ segmentçš„å¼•ç”¨è®¡æ•°ï¼Œä¸º0æ‰å¯ä»¥åˆ é™¤
* æ­£æ’ä¹Ÿæ˜¯b+treeæ“ä½œ

#### engine å¯¹è±¡
> engineæ˜¯recallå¬å›å’Œindexç´¢å¼•çš„æ§åˆ¶æ¨¡å—
* é€šè¿‡engine modeåŒºåˆ†æ˜¯æŸ¥è¯¢è¿˜æ˜¯å†™å…¥ï¼Œä¸»è¦éœ€è¦æ ‡è¯†å‡ºè¦å¤„ç†çš„segmentï¼Œrecallä½¿ç”¨cur_seg_idï¼Œindexä½¿ç”¨next_seg_id
* å¬å›å’Œç´¢å¼•æ˜¯ä¸åŒçš„engine
* å¬å›ä¸Šå±‚æœ‰å¤šä¸ªengine
* recall å¬å›æ—¶ä¼šåœ¨engineä¸Šå±‚è¿›è¡Œå¤šsegmentåˆå¹¶ï¼ˆå•ä¸ªsegmentæ²¡é—®é¢˜ï¼Œå¤šä¸ªæœ‰æ—¶å€™æœ‰é—®é¢˜ï¼Œä¼šé˜»å¡ï¼Œåç»­ä¼˜åŒ–ä¸€ä¸‹ï¼‰

### æœªæ¥è§„åˆ’
#### 1.æ¶æ„ç›¸å…³

- [ ] å¼•å…¥é™çº§ç†”æ–­
- [ ] å¼•å…¥jaegerè¿›è¡Œé“¾è·¯è¿½è¸ª
- [ ] å¼•å…¥skywalkingè¿›è¡Œç›‘æ§

#### 2.åŠŸèƒ½ç›¸å…³

- [ ] æ„å»ºç´¢å¼•çš„æ—¶å€™å¤ªæ…¢äº†..æƒ³åŠæ³•ä¼˜åŒ–..éƒ½ä¸çŸ¥é“wukongæ˜¯æ€ä¹ˆåšçš„æ„å»ºç´¢å¼•é‚£ä¹ˆå¿«çš„...
- [ ] ç´¢å¼•å‹ç¼©ï¼Œboltäº§ç”Ÿçš„ä¸‰ä¸ªæ–‡ä»¶è¿‡å¤šï¼Œå¤ªå¤§äº†ï¼Œå› ä¸ºç›®å‰å­˜çš„æ˜¯postingsListï¼Œä¹Ÿå°±æ˜¯å€’æ’ç´¢å¼•è¡¨ï¼Œåç»­æ”¹æˆå­˜offset
- [x] ç›¸å…³æ€§çš„è®¡ç®—è¦è€ƒè™‘ä¸€ä¸‹ï¼ŒTFIDFï¼Œbm25
- [ ] è¯å‘é‡ï¼Œpagerank
- [x] åˆ†è¯åŠ å…¥ikåˆ†è¯å™¨
- [ ] å¤šä¸ªsegmentå¬å›ç»“åˆåˆå¹¶ï¼Œå¹¶ä¸”å·®è¿è¾“
- [ ] åˆ†é¡µï¼Œæ’åº
- [ ] çº æ­£è¾“å…¥çš„query,æ¯”å¦‚â€œé™†åŠ å˜´â€-->â€œé™†å®¶å˜´â€
- [ ] è¾“å…¥è¿›è¡Œè¯æ¡å¯ä»¥è¿›è¡Œè”æƒ³ï¼Œæ¯”å¦‚ â€œä¸œæ–¹æ˜â€ æç¤º--> â€œä¸œæ–¹æ˜ç â€
- [ ] ç›®å‰æ˜¯åŸºäºå—çš„ç´¢å¼•æ–¹æ³•ï¼Œåç»­çœ‹çœ‹èƒ½ä¸èƒ½æ”¹æˆåˆ†å¸ƒå¼mapreduceæ¥æ„å»ºç´¢å¼•
- [ ] åœ¨ä¸Šä¸€æ¡çš„åŸºç¡€ä¸Šå†åŠ ä¸ŠåŠ¨æ€ç´¢å¼•ï¼ˆè¿˜ä¸çŸ¥é“ä¸Šä¸€æ¡èƒ½ä¸èƒ½å®ç°...ï¼‰


# é¡¹ç›®ä¸»è¦ä¾èµ–
- gin
- gorm
- etcd
- grpc
- jwt-go
- logrus
- viper
- protobuf

# âœ¨ é¡¹ç›®ç»“æ„

## 1.tangseng é¡¹ç›®æ€»ä½“
```
tangseng/
â”œâ”€â”€ app                   // å„ä¸ªå¾®æœåŠ¡
â”‚   â”œâ”€â”€ favorite          // æ”¶è—å¤¹
â”‚   â”œâ”€â”€ gateway           // ç½‘å…³
â”‚   â”œâ”€â”€ search-engine     // æ–°ç‰ˆæœç´¢å¾®æœåŠ¡
â”‚   â””â”€â”€ user              // ç”¨æˆ·æ¨¡å—å¾®æœåŠ¡
â”œâ”€â”€ bin                   // ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶æ¨¡å—
â”œâ”€â”€ config                // é…ç½®æ–‡ä»¶
â”œâ”€â”€ consts                // å®šä¹‰çš„å¸¸é‡
â”œâ”€â”€ doc                   // æ¥å£æ–‡æ¡£
â”œâ”€â”€ idl                   // protocæ–‡ä»¶
â”‚   â””â”€â”€ pb                // æ”¾ç½®ç”Ÿæˆçš„pbæ–‡ä»¶
â”œâ”€â”€ loading               // å…¨å±€çš„loadingï¼Œå„ä¸ªå¾®æœåŠ¡éƒ½å¯ä»¥ä½¿ç”¨çš„å·¥å…·
â”œâ”€â”€ logs                  // æ”¾ç½®æ‰“å°æ—¥å¿—æ¨¡å—
â”œâ”€â”€ pkg                   // å„ç§åŒ…
â”‚   â”œâ”€â”€ ctl               // ç”¨æˆ·ä¿¡æ¯ç›¸å…³
â”‚   â”œâ”€â”€ discovery         // etcdæœåŠ¡æ³¨å†Œã€keep-aliveã€è·å–æœåŠ¡ä¿¡æ¯ç­‰ç­‰
â”‚   â”œâ”€â”€ es                // es æ¨¡å—
â”‚   â”œâ”€â”€ jwt               // jwté‰´æƒ
â”‚   â”œâ”€â”€ logger            // æ—¥å¿—
â”‚   â”œâ”€â”€ res               // ç»Ÿä¸€responseæ¥å£è¿”å›
â”‚   â”œâ”€â”€ util              // å„ç§å·¥å…·ã€å¤„ç†æ—¶é—´ã€å¤„ç†å­—ç¬¦ä¸²ç­‰ç­‰..
â”‚   â””â”€â”€ wrappers          // ç†”æ–­
â””â”€â”€ types                 // å®šä¹‰å„ç§ç»“æ„ä½“
```

## 2.gateway ç½‘å…³éƒ¨åˆ†
```
gateway/
â”œâ”€â”€ cmd                   // å¯åŠ¨å…¥å£
â”œâ”€â”€ internal              // ä¸šåŠ¡é€»è¾‘ï¼ˆä¸å¯¹å¤–æš´éœ²ï¼‰
â”‚   â”œâ”€â”€ handler           // è§†å›¾å±‚
â”‚   â””â”€â”€ service           // æœåŠ¡å±‚
â”‚       â””â”€â”€ pb            // æ”¾ç½®ç”Ÿæˆçš„pbæ–‡ä»¶
â”œâ”€â”€ logs                  // æ”¾ç½®æ‰“å°æ—¥å¿—æ¨¡å—
â”œâ”€â”€ middleware            // ä¸­é—´ä»¶
â”œâ”€â”€ routes                // http è·¯ç”±æ¨¡å—
â””â”€â”€ rpc                   // rpc è°ƒç”¨
```

## 3.user && favorite ç”¨æˆ·ä¸æ”¶è—å¤¹æ¨¡å—
```
user/
â”œâ”€â”€ cmd                   // å¯åŠ¨å…¥å£
â””â”€â”€internal               // ä¸šåŠ¡é€»è¾‘ï¼ˆä¸å¯¹å¤–æš´éœ²ï¼‰
   â”œâ”€â”€ service            // ä¸šåŠ¡æœåŠ¡
   â””â”€â”€ repository         // æŒä¹…å±‚
       â””â”€â”€ db             // è§†å›¾å±‚
           â”œâ”€â”€ dao        // å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œ
           â””â”€â”€ model      // å®šä¹‰æ•°æ®åº“çš„æ¨¡å‹
```

## 4.search-engine æœç´¢å¼•æ“æ¨¡å—

```
seach-engine/
â”œâ”€â”€ cmd                   // å¯åŠ¨å…¥å£
â”œâ”€â”€ data                  // æ”¾ç½®æ‰“å°æ—¥å¿—æ¨¡å—
â”œâ”€â”€ engine                // ä¸­é—´ä»¶
â”œâ”€â”€ index                 // ç´¢å¼•å»ºç«‹
â”œâ”€â”€ inputdata             // è¾“å…¥çš„æ•°æ®
â”œâ”€â”€ logic                 // å…±æœ‰é€»è¾‘
â”œâ”€â”€ query                 // åˆ†è¯ æŸ¥è¯¢
â”œâ”€â”€ recall                // å›å½’
â”œâ”€â”€ respository           // å­˜å‚¨ä¿¡æ¯
â”œâ”€â”€ segment               // metaåˆ†å—
â”œâ”€â”€ service               // æœåŠ¡
â”œâ”€â”€ storage               // å­˜å‚¨ä¿¡æ¯
â”œâ”€â”€ test                  // æµ‹è¯•æ–‡ä»¶
â””â”€â”€ types                 // å®šä¹‰çš„ç»“æ„ä½“
```

# é¡¹ç›®æ–‡ä»¶é…ç½®

å°†configæ–‡ä»¶å¤¹ä¸‹çš„`config.yml.example`æ–‡ä»¶é‡å‘½åæˆ`config.yml`å³å¯ã€‚

```yaml
server:
  port: :4000
  version: 1.0
  jwtSecret: 38324-search-engine

mysql:
  driverName: mysql
  host: 127.0.0.1
  port: 3306
  database: search_engine
  username: search_engine
  password: search_engine
  charset: utf8mb4

redis:
  user_name: default
  address: 127.0.0.1:6379
  password:

etcd:
  address: 127.0.0.1:2379

services:
  gateway:
    name: gateway
    loadBalance: true
    addr:
      - 127.0.0.1:10001 

  user:
    name: user
    loadBalance: false
    addr:
      - 127.0.0.1:10002 # ç›‘å¬åœ°å€

  favorite:
    name: favorite
    loadBalance: false
    addr:
      - 127.0.0.1:10003 # ç›‘å¬åœ°å€

  searchEngine:
    name: favorite
    loadBalance: false
    addr:
      - 127.0.0.1:10004 # ç›‘å¬åœ°å€

domain:
  user:
    name: user
  favorite:
    name: favorite
  searchEngine:
    name: searchEngine
```


# é¡¹ç›®å¯åŠ¨
## makefileå¯åŠ¨

å¯åŠ¨å‘½ä»¤

```shell
make env-up         # å¯åŠ¨å®¹å™¨ç¯å¢ƒ
make user           # å¯åŠ¨ç”¨æˆ·æ‘¸å—
make task           # å¯åŠ¨ä»»åŠ¡æ¨¡å—
make gateway        # å¯åŠ¨ç½‘å…³
make env-down       # å…³é—­å¹¶åˆ é™¤å®¹å™¨ç¯å¢ƒ
```

å…¶ä»–å‘½ä»¤
```shell
make proto # ç”Ÿæˆprotoæ–‡ä»¶ï¼Œå¦‚æœprotoæœ‰æ”¹å˜çš„è¯ï¼Œåˆ™éœ€è¦é‡æ–°ç”Ÿæˆæ–‡ä»¶
```
ç”Ÿæˆ.pbæ–‡ä»¶æ‰€éœ€è¦çš„å·¥å…·æœ‰`protoc-gen-go`,`protoc-gen-go-grpc`,`protoc-go-inject-tag`


## æ‰‹åŠ¨å¯åŠ¨

1. åˆ©ç”¨composeå¿«é€Ÿæ„å»ºç¯å¢ƒ
```shell
docker-compose up -d
```
2. ä¿è¯mysql,etcdæ´»è·ƒ, åœ¨ app æ–‡ä»¶å¤¹ä¸‹çš„å„ä¸ªæ¨¡å—çš„ cmd ä¸‹æ‰§è¡Œ
```go
go run main.go
```

# å¯¼å…¥æ¥å£æ–‡æ¡£

æ‰“å¼€postmanï¼Œç‚¹å‡»å¯¼å…¥

![postmanå¯¼å…¥](doc/1.ç‚¹å‡»importå¯¼å…¥.png)

é€‰æ‹©å¯¼å…¥æ–‡ä»¶
![é€‰æ‹©å¯¼å…¥æ¥å£æ–‡ä»¶](doc/2.é€‰æ‹©æ–‡ä»¶.png)

![å¯¼å…¥](doc/3.å¯¼å…¥.png)

æ•ˆæœ

![postman](doc/4.æ•ˆæœ.png)
